---
title: 'データベース関数'
description: 'Next.js Supabaseスキーマで利用可能なデータベース関数について学ぶ'
icon: 'function-square'
order: 4
---

# Next.js Supabaseスキーマで利用可能なデータベース関数

データベーススキーマには、カスタムロジックとRLSでデータベースを拡張するために使用できるいくつかの関数が含まれています。

## ユーザーがアカウントの所有者であるかを確認する

この関数は、ユーザーがアカウントの所有者であるかどうかを確認します。アカウントテーブルでアカウント所有者へのアクセスを制限するために使用されます。

```sql
public.is_account_owner(account_id uuid)
```

これは、アカウントがユーザーのアカウントである場合、またはユーザーがチームアカウントを作成した場合にtrueになります。

## ユーザーがアカウントのメンバーであるかを確認する

この関数は、ユーザーがアカウントのメンバーであるかどうかを確認します。アカウントテーブルでアカウントメンバーへのアクセスを制限するために使用されます。

```sql
public.has_role_on_account(
  account_id uuid,
  account_role varchar(50) default null
)
```

`account_role`が提供されていない場合、ユーザーがアカウントのメンバーであればtrueを返します。`account_role`が提供されている場合、ユーザーがアカウントで指定されたロールを持っていればtrueを返します。

## ユーザーがアカウントのチームメンバーであるかを確認する

ユーザーがチームアカウントのメンバーであるかどうかを確認します。アカウントテーブルでチームメンバーへのアクセスを制限するために使用されます。

```sql
public.is_team_member(
  account_id uuid,
  user_id uuid
)
```

## アカウントが別のアカウントに対してアクションを実行する権限があるかを確認する

この関数は、アカウントが別のアカウントに対してアクションを実行する権限があるかどうかを確認します。アカウントテーブルでアカウント所有者へのアクセスを制限するために使用されます。

```sql
public.can_action_account_member(
  target_team_account_id uuid,
  target_user_id uuid
)
```

この関数は以下を行います：
- 現在のユーザーがターゲットアカウントの所有者であるかを確認：その場合、trueを返します
- ターゲットユーザーがターゲットアカウントの所有者であるかを確認：その場合、falseを返します
- 2つのアカウント間のロールの階層を比較：現在のユーザーがターゲットユーザーよりも高いロールを持っている場合、trueを返します

これは、ユーザーがアカウントから別のユーザーを削除できるかどうか、または権限が必要な他のアクションを確認するのに役立ちます。

## 権限の確認

ユーザーがアカウントに対して特定の権限を持っているかどうかを確認します。

```sql
public.has_permission(
  user_id uuid,
  account_id uuid,
  permission_name app_permissions
)
```

この関数は、ユーザーがアカウントに対して指定された権限を持っている場合にtrueを返します。

権限は列挙型`app_permissions`で指定されています。この列挙型を拡張して、さらに権限を追加できます。

## 設定が設定されているかを確認する

`public.config`テーブルで設定が設定されているかどうかを確認します。

```sql
public.is_set(
  field_name text
)
```

## アカウントがアクティブなサブスクリプションを持っているかを確認する

アカウントがアクティブなサブスクリプションを持っているかどうかを確認します。

```sql
public.has_active_subscription(
  account_id uuid
)
```

これは、サブスクリプションのステータスが「アクティブ」または「トライアル中」であることを意味します。つまり、アカウントの請求状態が良好である（例：未払いの請求書がない）ということです。

これは重要です。なぜなら、サブスクリプションが存在するかどうかを確認するだけでは不十分だからです。ステータスは様々（例：キャンセル済み、不完全、期限切れ、期限超過、未払い）である可能性があるため、サブスクリプションがアクティブであるかどうかを確認する必要があります。

## アカウントがスーパー管理者であるかを確認する

アカウントがスーパー管理者であるかどうかを確認します。

```sql
public.is_super_admin()
```

この関数には以下が必要です：
- ユーザーが認証されていること
- ユーザーが`super_admin`ロールを持っていること
- ユーザーが現在MFAでサインインしていること

## アカウントがMFAに準拠しているかを確認する

アカウントがMFAに準拠しているかどうかを確認します - 例：
- ユーザーがMFAを有効にし、現在MFAでサインインしている
- ユーザーがMFAを有効にしておらず、現在AAL1でサインインしている

```sql
public.is_mfa_compliant()
```

これは以下を確保するのに役立ちます：
- MFAを持つユーザーがMFAポリシーに準拠している
- MFAを持たないユーザーがMFAなしでアプリケーションにアクセスし続けることができる

代わりに、ユーザーにMFAの使用を強制するには、以下の`public.is_aal2`関数を使用してください。

## アカウントがMFAでサインインしているかを確認する

アカウントがMFA（AAL2）でサインインしているかどうかを確認します。これは、ユーザーがMFAでサインインしているかどうかに基づいて特定のテーブルへのアクセスを制限したい場合に役立ちます。

```sql
public.is_aal2()
```
