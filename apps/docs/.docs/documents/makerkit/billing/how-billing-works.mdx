---
title: 'Next.js Supabase SaaS Kitでの課金の仕組み'
description: 'Makerkitでの課金システムの概要と設定方法を学ぶ'
icon: 'credit-card'
order: 1
---

# Next.js Supabase SaaS Kitでの課金の仕組み

Makerkitでの課金システムの概要と設定方法について説明します。

## 概要

課金パッケージは、サブスクリプション、一回払い、その他の支払い管理に使用されます。

このパッケージは、支払いゲートウェイ（Stripe、Lemon Squeezyなど）を管理するための課金ゲートウェイパッケージから抽象化されています。

課金パッケージを設定するには、以下の環境変数を設定する必要があります：

```bash
NEXT_PUBLIC_BILLING_PROVIDER=stripe # または lemon-squeezy
```

## Makerkitでの課金システム

Makerkitは課金管理のために2つのパッケージを実装しています：

1. **core**: 課金サービスとスキーマを提供する基本パッケージ
2. **gateway**: 課金サービスと課金プロバイダー（Stripe、Lemon Squeezyなど）を処理するルーター

さらに、各プロバイダー用のパッケージが定義されています：

- **stripe**: Stripe APIを処理するパッケージ
- **lemon-squeezy**: Lemon Squeezy APIを処理するパッケージ
- **paddle**: Paddle APIを処理するパッケージ（近日公開）

まとめると：

- coreはサービスとスキーマを定義
- プロバイダーのパッケージは各プロバイダーのAPIに基づいてAPI呼び出しを定義
- gatewayパッケージはリクエストを適切なプロバイダーにルーティング

選択したプロバイダーに関係なく、`NEXT_PUBLIC_BILLING_PROVIDER`環境変数を使用するプロバイダーに設定する必要があります。Gateway Serviceは自動的にリクエストを適切なプロバイダーにルーティングします。これにより、コードを変更することなくプロバイダーを切り替えることができます。スキーマはすべてのプロバイダーで同じですが、API呼び出しの詳細は異なるため、一部の詳細が適用されます。

## サブスクリプションと一回払い

Makerkitはサブスクリプションと一回払いの両方をサポートしています。どちらか一方または両方を使用することができます。デフォルトでは、SaaSアプリケーションで最も一般的な課金モードであるサブスクリプションを使用することを想定しています。

つまり、デフォルトでは、個人またはチームアカウントの課金セクションを訪問する際に、Makerkitはサブスクリプションプランを検索します。これは`subscriptions`テーブルと`subscription_items`テーブルからデータを取得することを意味します。

一回払いを使用する場合は、課金モードを`one-time`に設定する必要があります：

```bash
BILLING_MODE=one-time
```

これにより、個人またはチームアカウントの課金セクションを訪問する際に、Makerkitは一回払いを検索します。これは`orders`テーブルと`order_items`テーブルからデータを取得することを意味します。

## 両方のモードを使用したい場合

両方のモードを使用することも可能ですが、正しいデータを表示するようにページをカスタマイズする必要があります。

使用するサービスに応じて、環境変数を適切に設定する必要があります。デフォルトでは、課金パッケージはStripeを使用します。代替としてLemon Squeezyを使用することもできます。将来的にはPaddleも追加される予定です。

## 実装のベストプラクティス

1. **課金モードの選択**
   - ビジネスモデルに適した課金モードを選択
   - 必要に応じて両方のモードを組み合わせて使用

2. **環境変数の管理**
   - プロバイダーの適切な設定
   - 課金モードの明示的な指定

3. **データ構造の理解**
   - サブスクリプション用のテーブル構造
   - 一回払い用のテーブル構造
   - 両方のモードを使用する場合の設計考慮事項
