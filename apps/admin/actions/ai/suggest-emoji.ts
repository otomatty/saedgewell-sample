'use server';

import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');

// çµµæ–‡å­—ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ãã®èª¬æ˜
const emojiDatabase = {
  faces:
    'ğŸ˜€ ğŸ˜ƒ ğŸ˜„ ğŸ˜ ğŸ˜… ğŸ˜‚ ğŸ¤£ â˜ºï¸ ğŸ˜Š ğŸ˜‡ ğŸ™‚ ğŸ™ƒ ğŸ˜‰ ğŸ˜Œ ğŸ˜ ğŸ¥° ğŸ˜˜ ğŸ˜— ğŸ˜™ ğŸ˜š ğŸ˜‹ ğŸ˜› ğŸ˜ ğŸ˜œ ğŸ¤ª ğŸ¤¨ ğŸ§ ğŸ¤“ ğŸ˜ ğŸ¤© ğŸ¥³ ğŸ˜ ğŸ˜’ ğŸ˜ ğŸ˜” ğŸ˜Ÿ ğŸ˜• ğŸ™ â˜¹ï¸ ğŸ˜£ ğŸ˜– ğŸ˜« ğŸ˜© ğŸ¥º ğŸ˜¢ ğŸ˜­ ğŸ˜¤ ğŸ˜  ğŸ˜¡ ğŸ¤¬ ğŸ¤¯ ğŸ˜³ ğŸ¥µ ğŸ¥¶ ğŸ˜± ğŸ˜¨ ğŸ˜° ğŸ˜¥ ğŸ˜“ ğŸ¤— ğŸ¤” ğŸ¤­ ğŸ¤« ğŸ¤¥ ğŸ˜¶ ğŸ˜ ğŸ˜‘ ğŸ˜¬ ğŸ™„ ğŸ˜¯ ğŸ˜¦ ğŸ˜§ ğŸ˜® ğŸ˜² ğŸ¥± ğŸ˜´ ğŸ¤¤ ğŸ˜ª ğŸ˜µ ğŸ¤ ğŸ¥´ ğŸ¤¢ ğŸ¤® ğŸ¤§ ğŸ˜· ğŸ¤’ ğŸ¤•',
  gestures:
    'ğŸ‘‹ ğŸ¤š âœ‹ ğŸ– ğŸ‘Œ ğŸ¤Œ ğŸ¤ âœŒï¸ ğŸ¤ ğŸ«° ğŸ¤Ÿ ğŸ¤˜ ğŸ¤™ ğŸ‘ˆ ğŸ‘‰ ğŸ‘† ğŸ–• ğŸ‘‡ â˜ï¸ ğŸ‘ ğŸ‘ âœŠ ğŸ‘Š ğŸ¤› ğŸ¤œ ğŸ‘ ğŸ™Œ ğŸ‘ ğŸ¤² ğŸ¤ ğŸ™ âœï¸ ğŸ’… ğŸ¤³ ğŸ’ª ğŸ¦¾ ğŸ¦¿ ğŸ¦µ ğŸ¦¶ ğŸ‘‚ ğŸ¦» ğŸ‘ƒ ğŸ«€ ğŸ« ğŸ§  ğŸ¦· ğŸ¦´ ğŸ‘€ ğŸ‘ ğŸ‘… ğŸ‘„',
  nature:
    'ğŸŒ¸ ğŸŒº ğŸŒ¹ ğŸŒ· ğŸŒ¼ ğŸŒ» ğŸŒ ğŸŒ ğŸŒ› ğŸŒœ â­ ğŸŒŸ âœ¨ ğŸ’« â˜€ï¸ ğŸŒ¤ â›… ğŸŒ¥ â˜ï¸ ğŸŒ¦ ğŸŒ§ â›ˆ ğŸŒ© ğŸŒ¨ â„ï¸ ğŸŒ¬ ğŸ’¨ ğŸŒª ğŸŒ« ğŸŒŠ ğŸŒ± ğŸŒ² ğŸŒ³ ğŸŒ´ ğŸŒµ ğŸŒ¾ ğŸŒ¿ â˜˜ï¸ ğŸ€ ğŸ ğŸ‚ ğŸƒ',
  food: 'ğŸ ğŸ ğŸŠ ğŸ‹ ğŸŒ ğŸ‰ ğŸ‡ ğŸ“ ğŸ« ğŸˆ ğŸ’ ğŸ‘ ğŸ¥­ ğŸ ğŸ¥¥ ğŸ¥ ğŸ… ğŸ† ğŸ¥‘ ğŸ¥¦ ğŸ¥¬ ğŸ¥’ ğŸŒ¶ ğŸ«‘ ğŸ¥• ğŸ§„ ğŸ§… ğŸ¥” ğŸ  ğŸ¥ ğŸ¥¯ ğŸ ğŸ¥– ğŸ¥¨ ğŸ§€ ğŸ¥š ğŸ³ ğŸ§ˆ ğŸ¥ ğŸ§‡ ğŸ¥“ ğŸ¥© ğŸ— ğŸ– ğŸ¦´ ğŸŒ­ ğŸ” ğŸŸ ğŸ• ğŸ«“ ğŸ¥ª ğŸ¥™ ğŸ§† ğŸŒ® ğŸŒ¯ ğŸ«” ğŸ¥— ğŸ¥˜ ğŸ«• ğŸ¥« ğŸ ğŸœ ğŸ² ğŸ› ğŸ£ ğŸ± ğŸ¥Ÿ ğŸ¦ª ğŸ¤ ğŸ™ ğŸš ğŸ˜ ğŸ¥ ğŸ¥  ğŸ¥® ğŸ¢ ğŸ¡ ğŸ§ ğŸ¨ ğŸ¦ ğŸ¥§ ğŸ§ ğŸ° ğŸ‚ ğŸ® ğŸ­ ğŸ¬ ğŸ« ğŸ¿ ğŸ© ğŸª ğŸŒ° ğŸ¥œ ğŸ¯ ğŸ¥› ğŸ¼ ğŸ«– â˜•ï¸ ğŸµ ğŸ§ƒ ğŸ¥¤ ğŸ§‹ ğŸ¶ ğŸº ğŸ» ğŸ¥‚ ğŸ· ğŸ¥ƒ ğŸ¸ ğŸ¹ ğŸ§‰ ğŸ¾ ğŸ§Š ğŸ¥„ ğŸ´ ğŸ½ ğŸ¥¢ ğŸ¥¡',
  activities:
    'ğŸ’» ğŸ“± ğŸ’¡ ğŸ® ğŸ¨ ğŸ­ ğŸª ğŸ¢ ğŸ¡ ğŸ¯ ğŸ² ğŸ³ ğŸ® ğŸ° ğŸ¨ ğŸ–¼ ğŸ­ ğŸª ğŸ¢ ğŸ¡ ğŸ¯ ğŸ² ğŸ³ ğŸ® ğŸ° ğŸš— âœˆï¸ ğŸš€ ğŸ›¸ ğŸ‰ ğŸŠ ğŸˆ ğŸ ğŸ— ğŸŸ ğŸ« ğŸ– ğŸ† ğŸ¥‡ ğŸ¥ˆ ğŸ¥‰ ğŸ… ğŸ­ ğŸ¨ ğŸª ğŸ¤ ğŸ§ ğŸ¼ ğŸ¹ ğŸ¥ ğŸ· ğŸº ğŸ¸ ğŸª• ğŸ» ğŸ² ğŸ¯ ğŸ³ ğŸ® ğŸ° ğŸ§©',
  objects:
    'ğŸ“š ğŸ“– ğŸ“ âœï¸ ğŸ“Œ ğŸ“ ğŸ“ ğŸ” ğŸ” ğŸ” ğŸ”‘ ğŸ”¨ ğŸª› ğŸ”§ ğŸªœ ğŸ§° ğŸ ğŸˆ ğŸ€ ğŸŠ ğŸ‰ ğŸ­ ğŸª ğŸ¢ ğŸ¡ ğŸ¯ ğŸ² ğŸ³ ğŸ® ğŸ° ğŸ’¡ ğŸ”¦ ğŸ® ğŸ“” ğŸ“• ğŸ“— ğŸ“˜ ğŸ“™ ğŸ“š ğŸ“– ğŸ”– ğŸ§· ğŸ“ ğŸ“ ğŸ“Œ ğŸ“ ğŸ“ ğŸ–‡ ğŸ“ âœï¸ ğŸ” ğŸ” ğŸ” ğŸ” ğŸ”’ ğŸ”“ â¤ï¸ ğŸ§¡ ğŸ’› ğŸ’š ğŸ’™ ğŸ’œ ğŸ–¤ ğŸ¤ ğŸ¤ ğŸ’” â£ï¸ ğŸ’• ğŸ’ ğŸ’“ ğŸ’— ğŸ’– ğŸ’˜ ğŸ’ ğŸ’Ÿ â˜®ï¸ âœï¸ â˜ªï¸ ğŸ•‰ â˜¸ï¸ âœ¡ï¸ ğŸ”¯ ğŸ• â˜¯ï¸ â˜¦ï¸ ğŸ› â› â™ˆï¸ â™‰ï¸ â™Šï¸ â™‹ï¸ â™Œï¸ â™ï¸ â™ï¸ â™ï¸ â™ï¸ â™‘ï¸ â™’ï¸ â™“ï¸ ğŸ†” âš›ï¸ ğŸ‰‘ â˜¢ï¸ â˜£ï¸ ğŸ“´ ğŸ“³ ğŸˆ¶ ğŸˆšï¸ ğŸˆ¸ ğŸˆº ğŸˆ·ï¸ âœ´ï¸ ğŸ†š ğŸ’® ğŸ‰ ãŠ™ï¸ ãŠ—ï¸ ğŸˆ´ ğŸˆµ ğŸˆ¹ ğŸˆ² ğŸ…°ï¸ ğŸ…±ï¸ ğŸ† ğŸ†‘ ğŸ…¾ï¸ ğŸ†˜ âŒ â­•ï¸ ğŸ›‘ â›”ï¸ ğŸ“› ğŸš« ğŸ’¯ ğŸ’¢ â™¨ï¸ ğŸš· ğŸš¯ ğŸš³ ğŸš± ğŸ” ğŸ“µ ğŸš­ â—ï¸ â• â“ â” â€¼ï¸ â‰ï¸ ğŸ”… ğŸ”† ã€½ï¸ âš ï¸ ğŸš¸ ğŸ”± âšœï¸ ğŸ”° â™»ï¸ âœ… ğŸˆ¯ï¸ ğŸ’¹ â‡ï¸ âœ³ï¸ â ğŸŒ ğŸ’  â“‚ï¸ ğŸŒ€ ğŸ’¤ ğŸ§ ğŸš¾ â™¿ï¸ ğŸ…¿ï¸ ğŸ›— ğŸˆ³ ğŸˆ‚ï¸ ğŸ›‚ ğŸ›ƒ ğŸ›„ ğŸ›… ğŸš¹ ğŸšº ğŸš¼ âš§ ğŸš» ğŸš® ğŸ¦ ğŸ“¶ ğŸˆ ğŸ”£ â„¹ï¸ ğŸ”¤ ğŸ”¡ ğŸ”  ğŸ†– ğŸ†— ğŸ†™ ğŸ†’ ğŸ†• ğŸ†“ 0ï¸âƒ£ 1ï¸âƒ£ 2ï¸âƒ£ 3ï¸âƒ£ 4ï¸âƒ£ 5ï¸âƒ£ 6ï¸âƒ£ 7ï¸âƒ£ 8ï¸âƒ£ 9ï¸âƒ£ ğŸ”Ÿ ğŸ”¢ #ï¸âƒ£ *ï¸âƒ£ âï¸ â–¶ï¸ â¸ â¯ â¹ âº â­ â® â© âª â« â¬ â—€ï¸ ğŸ”¼ ğŸ”½ â¡ï¸ â¬…ï¸ â¬†ï¸ â¬‡ï¸ â†—ï¸ â†˜ï¸ â†™ï¸ â†–ï¸ â†•ï¸ â†”ï¸ â†ªï¸ â†©ï¸ â¤´ï¸ â¤µï¸ ğŸ”€ ğŸ” ğŸ”‚ ğŸ”„ ğŸ”ƒ ğŸµ ğŸ¶ â• â– â— âœ–ï¸ â™¾ ğŸ’² ğŸ’± â„¢ï¸ Â©ï¸ Â®ï¸ ã€°ï¸ â° â¿ ğŸ”š ğŸ”™ ğŸ”› ğŸ” ğŸ”œ âœ”ï¸ â˜‘ï¸ ğŸ”˜ ğŸ”´ ğŸŸ  ğŸŸ¡ ğŸŸ¢ ğŸ”µ ğŸŸ£ âš«ï¸ âšªï¸ ğŸŸ¤ ğŸ”º ğŸ”» ğŸ”¸ ğŸ”¹ ğŸ”¶ ğŸ”· ğŸ”³ ğŸ”² â–ªï¸ â–«ï¸ â—¾ï¸ â—½ï¸ â—¼ï¸ â—»ï¸ ğŸŸ¥ ğŸŸ§ ğŸŸ¨ ğŸŸ© ğŸŸ¦ ğŸŸª â¬›ï¸ â¬œï¸ ğŸŸ« ğŸ”ˆ ğŸ”‡ ğŸ”‰ ğŸ”Š ğŸ”” ğŸ”• ğŸ“£ ğŸ“¢ ğŸ‘â€ğŸ—¨ ğŸ’¬ ğŸ’­ ğŸ—¯ â™ ï¸ â™£ï¸ â™¥ï¸ â™¦ï¸ ğŸƒ ğŸ´ ğŸ€„ï¸ ğŸ• ğŸ•‘ ğŸ•’ ğŸ•“ ğŸ•” ğŸ•• ğŸ•– ğŸ•— ğŸ•˜ ğŸ•™ ğŸ•š ğŸ•› ğŸ•œ ğŸ• ğŸ• ğŸ•Ÿ ğŸ•  ğŸ•¡ ğŸ•¢ ğŸ•¤ ğŸ•¥ ğŸ•¦ ğŸ•§',
};

// ãƒ©ãƒ³ãƒ€ãƒ ãªçµµæ–‡å­—ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getRandomEmojis(count: number): string[] {
  const allEmojis = Object.values(emojiDatabase)
    .join(' ')
    .split(' ')
    .filter((emoji) => emoji.trim());

  const randomEmojis: string[] = [];
  for (let i = 0; i < count; i++) {
    const randomIndex = Math.floor(Math.random() * allEmojis.length);
    const emoji = allEmojis[randomIndex];
    if (emoji) {
      randomEmojis.push(emoji);
    }
  }

  return randomEmojis;
}

// çµµæ–‡å­—ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
function extractEmojis(text: string): string[] {
  const emojiRegex = /[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu;
  const matches = text.match(emojiRegex);
  return matches || [];
}

const systemPrompt = `
ã‚ãªãŸã¯çµµæ–‡å­—ææ¡ˆã®å°‚é–€å®¶ã§ã™ã€‚
ä¸ãˆã‚‰ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã®å†…å®¹ã‚„æ„Ÿæƒ…ã‚’åˆ†æã—ã€æœ€ã‚‚é©åˆ‡ãªçµµæ–‡å­—ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®ç‚¹ã‚’è€ƒæ…®ã—ã¦ææ¡ˆã‚’è¡Œã£ã¦ãã ã•ã„ï¼š

1. ãƒ†ã‚­ã‚¹ãƒˆã®ä¸»è¦ãªãƒ†ãƒ¼ãƒã‚„æ¦‚å¿µ
2. ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ„Ÿã˜ã‚‰ã‚Œã‚‹æ„Ÿæƒ…ã‚„é›°å›²æ°—
3. ãƒ†ã‚­ã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹å…·ä½“çš„ãªç‰©äº‹ã‚„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
4. æ¥­å‹™ã‚„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢é€£ã™ã‚‹å ´åˆã¯ã€ãã®ç›®çš„ã‚„æ€§è³ª

ææ¡ˆã™ã‚‹çµµæ–‡å­—ã¯ï¼š
- æ–‡è„ˆã«æœ€ã‚‚é©ã—ã¦ã„ã‚‹
- è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„
- ä¸€èˆ¬çš„ã«èªè­˜ã•ã‚Œã‚„ã™ã„
- ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå ´é¢ã§ã‚‚ä½¿ç”¨å¯èƒ½

è¿”ç­”ã¯çµµæ–‡å­—ã®ã¿ã‚’å«ã‚€é…åˆ—å½¢å¼ã¨ã—ã€5ã¤ã®çµµæ–‡å­—ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
é©åˆ‡ãªçµµæ–‡å­—ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€"NO_SUITABLE_EMOJI"ã¨è¿”ã—ã¦ãã ã•ã„ã€‚
`;

export async function suggestEmojis(
  text: string
): Promise<{ emojis: string[]; error?: string }> {
  try {
    const model = genAI.getGenerativeModel({ model: 'gemini-pro' });

    const prompt = `
ãƒ†ã‚­ã‚¹ãƒˆ: ${text}

ã“ã®ãƒ†ã‚­ã‚¹ãƒˆã«æœ€ã‚‚é©ã—ãŸçµµæ–‡å­—ã‚’5ã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®çµµæ–‡å­—ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰é¸æŠã™ã‚‹ã‹ã€ãƒ†ã‚­ã‚¹ãƒˆã®å†…å®¹ã‹ã‚‰é€£æƒ³ã•ã‚Œã‚‹é©åˆ‡ãªçµµæ–‡å­—ã‚’ææ¡ˆã—ã¦ãã ã•ã„ï¼š

${Object.entries(emojiDatabase)
  .map(([category, emojis]) => `${category}: ${emojis}`)
  .join('\n')}

çµµæ–‡å­—ã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚ä½™è¨ˆãªèª¬æ˜ã¯ä¸è¦ã§ã™ã€‚
é©åˆ‡ãªçµµæ–‡å­—ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€"NO_SUITABLE_EMOJI"ã¨è¿”ã—ã¦ãã ã•ã„ã€‚
`;

    const result = await model.generateContent([
      { text: systemPrompt },
      { text: prompt },
    ]);
    const response = await result.response;
    const responseText = response.text();

    if (responseText.includes('NO_SUITABLE_EMOJI')) {
      return {
        emojis: getRandomEmojis(10),
      };
    }

    const emojis = extractEmojis(responseText);

    if (emojis.length === 0) {
      return {
        emojis: getRandomEmojis(10),
      };
    }

    return {
      emojis: emojis.slice(0, 5),
    };
  } catch (error) {
    return {
      emojis: [],
      error: 'çµµæ–‡å­—ã®ææ¡ˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
    };
  }
}
